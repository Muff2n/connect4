from src.connect4.board import Board
from src.connect4.player import ComputerPlayer
from src.connect4.searching import GridSearch, MCTS

import anytree
import pytest

import numpy as np

from copy import copy

o_pieces = [
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 1, 0, 0, 0, 0],
         [1, 0, 0, 1, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 1, 0, 0, 0, 0],
         [1, 0, 0, 1, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 1, 1, 0],
         [0, 0, 0, 1, 0, 0, 1],
         [0, 0, 1, 0, 1, 1, 1],
         [0, 0, 1, 0, 1, 1, 1]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 1, 1, 0, 0]], dtype=np.bool_)

]

x_pieces = [
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 0, 0, 0, 0, 0],
         [0, 1, 0, 0, 0, 0, 0],
         [0, 1, 1, 0, 1, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [1, 0, 0, 0, 0, 0, 0],
         [0, 1, 0, 0, 0, 0, 0],
         [0, 1, 1, 0, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 1, 0, 0, 0, 0, 0],
         [0, 1, 0, 0, 0, 0, 0],
         [0, 1, 0, 0, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 1, 1, 0, 0],
         [0, 0, 0, 1, 1, 1, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 0, 0, 0, 1, 1, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 1, 0, 1, 0, 0, 0]], dtype=np.bool_),
    np.array(
        [[0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0],
         [0, 0, 0, 1, 0, 0, 0],
         [0, 0, 0, 0, 0, 0, 0]], dtype=np.bool_)
]

plies = [1, 2, 2, 4, 4]
ans = [[1], [1], [1], [6], [2, 5]]

assert len(o_pieces) == len(x_pieces) == len(plies) == len(ans)


@pytest.mark.parametrize("n,o_pieces,x_pieces,plies,ans",
                         [(n, o, x, d, a) for n, o, x, d, a in zip(range(len(ans)), o_pieces, x_pieces, plies, ans)])
def test_next_move(n, o_pieces, x_pieces, plies, ans):
    computers = [ComputerPlayer("grid_test",
                                GridSearch(plies=plies)),
                 ComputerPlayer("mcts_test",
                                MCTS(MCTS.Config(simulations=7**plies,
                                                 cpuct=9999)))]
    for computer in computers:
        board = Board(o_pieces=copy(o_pieces),
                      x_pieces=copy(x_pieces))

        print(board)

        move, _ = computer.make_move(board)

        if plies <= 2:
            for pre, fill, node in anytree.RenderTree(computer.tree.root):
                print("%s%s, %s, %s, %s, %s" % (pre,
                    node.name,
                    node.data.board.result,
                    node.data.position_evaluation,
                    node.data.search_evaluation,
                    node.data.value))


        assert move in ans
    return


def test_multiple_moves():
    board = Board()

    computer = ComputerPlayer("test_name",
                              GridSearch(plies=4))
    board.make_move(3)

    assert computer.make_move(board)[0] == 3

    board.make_move(3)

    assert computer.make_move(board)[0] == 3

    board.make_move(4)

    assert computer.make_move(board)[0] == 2
